# WealthWing Backend (FastAPI + SQLAlchemy, Async)

FastAPI backend for **WealthWing** — personal finance & docs.  
Async stack with PostgreSQL (`asyncpg`), SQLAlchemy 2.0, Alembic, and Uvicorn. Optional AWS Cognito/S3 hooks.

## ✨ Features

- Async PostgreSQL via `asyncpg`
- SQLAlchemy 2.0 + Alembic migrations
- OpenAPI docs at `/docs` and `/redoc`
- Health & DB connectivity endpoints
- Clean module layout (routers/schemas/services)

## Quick Start (Docker Compose)

1. **Clone the repository:**
   ```sh
   git clone <your-repo-url>
   cd wealth-wing-data
   ```

2. **Copy and edit the `.env` file:**
   - Set your secrets and database URL as needed. Example:
     ```env
     DB_URL=postgresql+asyncpg://amin:123123@postgres:5432/ww-db
     ```

3. **Start the backend and database:**
   ```sh
   docker-compose up --build
   ```
   - The API will be available at [http://localhost:5003/docs](http://localhost:5003/docs)
   - The database will be available on port 5434 (for local tools like DBeaver)

4. **Stop the services:**
   ```sh
   docker-compose down
   ```

---

## Local Development (without Docker)

1. **Create and activate a virtual environment:**
   ```sh
   python3 -m venv venv
   source venv/bin/activate
   ```

2. **Install dependencies:**
   ```sh
   pip install --upgrade pip
   pip install -r requirements.txt
   ```

3. **Set up PostgreSQL locally**
   - See [documentation/DOCKER.md](documentation/DOCKER.md) for details.
   - Example connection string for local dev:
     ```env
     DB_URL=postgresql+asyncpg://admin:123123@localhost:5434/ww-db
     ```

4. **Run database migrations:**
   ```sh
   alembic upgrade head
   ```

5. **Start the server:**
   ```sh
   uvicorn src.main:api --reload --port 5003
   ```
   - Visit [http://localhost:5003/docs](http://localhost:5003/docs) for the API docs.

---

## Database

- The backend uses PostgreSQL. You can run it via Docker Compose or install it locally.
- Database migrations are managed with Alembic. See [documentation/ALEMBIC.md](documentation/ALEMBIC.md) for migration commands.

---

## Health Check

- `GET /ping` — Returns `{ "message": "healthy" }` if the API is running.
- `GET /test_db_connection` — Checks DB connectivity.

---

## Notes

- For production, set strong credentials and review all environment variables.
- Remove any sensitive keys from `.env` before sharing or deploying publicly.
- For async support, the backend uses `asyncpg`.
// ...existing code...
## Database

- The backend uses PostgreSQL. You can run it via Docker Compose or install it locally.
- Database migrations are managed with Alembic. See [documentation/ALEMBIC.md](documentation/ALEMBIC.md) for migration commands.

---

## Alembic migrations (local & Heroku)

This project uses Alembic for schema migrations. The app expects DB connection URL in the environment variable `DB_URL` (example: postgresql+asyncpg://user:pass@host:5432/dbname). Use the commands below to create and apply migrations.

Local (development)
1. Ensure your virtualenv is active and `DB_URL` is set:
```bash
# macOS / Linux
export DB_URL="postgresql+asyncpg://user:pass@localhost:5434/ww-db"
```
2. Create an autogenerated revision (inspect before applying):
```bash
alembic revision --autogenerate -m "describe changes"
```
3. Apply migrations:
```bash
alembic upgrade head
```
4. Useful commands:
```bash
alembic downgrade -1        # roll back one revision
alembic history --verbose   # show migration history
alembic current             # show current DB revision
alembic stamp head          # mark DB as up-to-date without running scripts
```

When running inside Docker Compose, set DB_URL to the service connection string (see Quick Start sample .env).

Heroku
Heroku provides a DATABASE_URL env var by default. If your app expects `DB_URL`, map it to `DATABASE_URL` and then run Alembic on the Heroku dyno:

1. Map DATABASE_URL -> DB_URL on Heroku:
```bash
# replace my-app-name with your Heroku app
heroku config:set DB_URL="$(heroku config:get DATABASE_URL -a my-app-name)" -a my-app-name
```
2. Run Alembic on the Heroku dyno:
```bash
# run migration on a one-off dyno
heroku run alembic upgrade head -a wealth-wing-be
```
If you prefer an interactive shell:
```bash
heroku run bash -a wealth-wing-be
# inside dyno
alembic upgrade head
```

Troubleshooting
- If alembic can't read the connection URL, confirm the project reads `DB_URL` in alembic/env.py or set that var locally/heroku.
- Inspect alembic/env.py to confirm it uses environment variables (it should load `DB_URL` or `DATABASE_URL`).
- Check logs if migrations fail:
```bash
heroku logs --tail -a my-app-name
```

Add migrations to git and commit them (migrations live in the `alembic` folder) so they deploy with your code:
```bash
git add alembic/versions
git commit -m "Add migration: ... "
git push heroku main
```

---
// ...existing code...
{ changed code }
// ...existing code...
## Heroku

- heroku login
- git add .
- git commit -am "make it better"
- git push heroku main



