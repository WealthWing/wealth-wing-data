# AGENTS.md

## Purpose
Use this guide when assisting on `wealth-wing-data`. Keep changes small, correct, and consistent with the existing FastAPI + async SQLAlchemy codebase.

## Project Snapshot
- Backend API for WealthWing personal finance workflows.
- Primary focus areas: transactions, categories, accounts, projects, subscriptions, and CSV-based bank imports.
- Current importer implementations: Chase checking (`chase_debit`) and Chase credit card (`chase_credit`).

## Stack
- Python 3.12
- FastAPI
- SQLAlchemy 2.x (async usage patterns)
- Alembic migrations
- PostgreSQL (`asyncpg`)
- Optional AWS Cognito/S3 integrations

## Key Entry Points
- App bootstrap: `main.py`
- Routers: `src/routers/`
- DB session/config: `src/database/connect.py`
- Models: `src/model/models.py`
- Schemas: `src/schemas/`
- Service layer: `src/services/`
- Import orchestration: `src/services/import_manager.py`
- Importers: `src/services/bank_importers/`
- Utilities: `src/util/`
- Migrations: `alembic/versions/`

## Local Commands
- Install deps: `pip install -r requirements.txt`
- Start API (script): `./run.sh`
- Start API (direct): `uvicorn main:app --reload --env-file .env`
- Start Postgres (Docker): `docker-compose up -d`
- Apply migrations: `alembic upgrade head`
- Create migration: `alembic revision --autogenerate -m "message"`

## Environment Notes
- Required for DB work: `DB_URL`
- Common app vars: `FE_URL`
- Auth/Cognito-related vars used by middleware:
  - `COGNITO_JWKS_URL`
  - `COGNITO_USER_POOL_ID`
  - `AWS_REGION`
  - `COGNITO_ISSUER`
  - `COGNITO_CLIENT_ID`

## Coding Rules For This Repo
- Prefer async-compatible patterns in service/DB paths.
- Keep router layer thin; put business logic in `src/services` and `src/util`.
- Preserve current naming and file organization conventions.
- Reuse existing helpers (`src/util/transaction.py`, `src/util/category.py`, etc.) before adding new utilities.
- For importer changes:
  - Keep fingerprint-based deduplication intact.
  - Normalize dates/amounts through existing utility functions.
  - Ensure `can_handle_file(...)` remains strict and explicit.
- Avoid unrelated refactors while fixing a specific issue.

## Migration Rules
- Any model/schema change that affects persistence must include an Alembic migration.
- Review autogenerated migration scripts before finalizing.
- Do not modify old migration history unless explicitly requested.

## Validation Checklist (Before Hand-off)
- App starts locally (`uvicorn main:app ...`).
- If DB-related code changed, run `alembic upgrade head`.
- For import flow changes, verify:
  - CSV parsing still succeeds.
  - Duplicates are not reinserted for same account.
  - Category/project mapping helpers still resolve IDs correctly.
- If tests are added/available, run them and report results.

## Response Expectations For Chat/Coding Agents
- Explain what changed and why, with file references.
- Call out assumptions and any unverified behavior.
- If something could not be run locally, state that clearly.
- Keep output concise and actionable.
